<!DOCTYPE html><html lang="zh" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.5.0 for Hugo" />
  

  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
    <meta name="google-site-verification" content="google69a5cccb61297807" />
    <meta name="baidu-site-verification" content="cqmZHEleVh" />
  
  
  
  
    
    
    
  
  

  <meta name="author" content="宋净超" />

  
  
  
    
  
  <meta name="description" content="WebAssembly 表。" />

  
  <link rel="alternate" hreflang="zh" href="https://lib.jimmysong.io/wasm-definitive-guide/wasm-tables/" />

  
  
  
    <meta name="theme-color" content="#0a55a7" />
  

  
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.c7b8d9abd591ba2253ea42747e3ac3f5.css" media="print" onload="this.media='all'">

  
  
  
    
    

    
    
    
    
      
      
    
    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.b26eb9b802629dccab300faa82cc98c7.css" />

  




<script async src="https://www.googletagmanager.com/gtag/js?id=G-MP490FS739"></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', "G-MP490FS739");
</script>


  


  


  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2a4b7f65b1839466beaa48d633aa60c1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
  
  

  

  
    <link rel="manifest" href="/manifest.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0f7d075e895d6f5f1f5fdbc1e33dc138_10087_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="https://lib.jimmysong.io/wasm-definitive-guide/wasm-tables/" />

  
  
  
  
  
  
  
  
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary_large_image" />
  
    <meta property="twitter:site" content="@jimmysongio" />
    <meta property="twitter:creator" content="@jimmysongio" />
  
  <meta property="og:site_name" content="云原生资料库" />
  <meta property="og:url" content="https://lib.jimmysong.io/wasm-definitive-guide/wasm-tables/" />
  <meta property="og:title" content="WebAssembly 表 | 云原生资料库" />
  <meta property="og:description" content="WebAssembly 表。" /><meta property="og:image" content="https://lib.jimmysong.io/media/sharing.png" />
    <meta property="twitter:image" content="https://lib.jimmysong.io/media/sharing.png" /><meta property="og:locale" content="zh" />
  
    
      <meta
        property="article:published_time"
        content="2023-01-26T00:00:00&#43;08:00"
      />
    
    <meta property="article:modified_time" content="2023-02-01T19:53:02&#43;08:00">
  

  



  

  

  





  <title>WebAssembly 表 | 云原生资料库</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="55954a91316e5fe2bf1175ca7a422fa2" >
  <button onclick="topFunction()" id="backTopBtn" title="Go to top"><i class="fa-solid fa-circle-up" aria-hidden="true"></i></button>
  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.62d6f8dfe8493f1c68557dde65bec362.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6 search-title">
          <p>搜索</p>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="关闭"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      
    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

      <div id="search-common-queries">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    











  


<header class="header--fixed">
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生资料库"
            
            ></a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/"><img src="/media/logo.svg" alt="云原生资料库"
          
          ></a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#books"><span>图书</span></a>
          </li>

          
          

          
          <li class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"><span>教程</span><span class="caret"></span>
            </a>
            <div class="dropdown-menu">
              
                <a class="dropdown-item" href="/kubernetes-handbook"><span>Kubernetes 基础教程</span></a>
              
                <a class="dropdown-item" href="https://academy.tetrate.io/courses/istio-fundamentals-zh"><span>Istio 基础教程</span></a>
              
                <a class="dropdown-item" href="https://academy.tetrate.io/courses/envoy-fundamentals-zh"><span>Envoy 基础教程</span></a>
              
            </div>
          </li>

          
          

          

          
          
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/blog"><span>译文</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#feed"><span>更新</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#tags"><span>标签</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>关于</span></a>
          </li>

          
          

          

          
          
          
            
              
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="https://jimmysong.io" target="_blank" rel="noopener"><span>Jimmy Song</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://jimmysong.io/contact/" data-toggle="tooltip" data-placement="bottom" title="联系" target="_blank" rel="noopener" aria-label="联系">
                <i class="fab fa-weixin" aria-hidden="true"></i>
              </a>
            </li>
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://twitter.com/jimmysongio" data-toggle="tooltip" data-placement="bottom" title="关注" target="_blank" rel="noopener" aria-label="关注">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        <li class="nav-item">
            <a class="nav-link" href="https://jimmysong.io" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="主站" aria-label="主站"><i class="fas fa-home" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item">
            <a class="nav-link js-search" href="#" data-toggle="tooltip" data-placement="bottom" title="搜索" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        <li class="nav-item d-none d-lg-inline-flex">
            <a class="nav-link" href="https://github.com/rootsongjc/cloud-native-library/" target="_blank" rel="noopener" data-toggle="tooltip" data-placement="bottom" title="查看源码" aria-label="查看源码" aria-label="GitHub"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item">
          <a href="#" class="nav-link set-theme">
            <i class="fa fa-sun" aria-hidden="true" id="theme-icon"></i>
          </a>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    




<div class="container-xl docs">
  <div class="row flex-xl-nowrap">
    <div class="docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
          WebAssembly 权威指南
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">搜索...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      



  
    
    
    
    
      
    
    

    
      <ul class="nav docs-sidenav">
          <li class="level "><a href="/wasm-definitive-guide/"><i class="fas fa-book-open pr-1"></i>WebAssembly 权威指南</a></li>
    
      



  <li class="child level "><a href="/wasm-definitive-guide/foreword/">译者序</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/introduction/">第 1 章：简介</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/hello-world/">第 2 章：入门</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/wasm-modules/">第 3 章：WebAssembly 模块</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/wasm-memory/">第 4 章：WebAssembly 内存</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/using-c-cpp-and-wasm/">第 5 章：使用 C/C&#43;&#43; 和 WebAssembly</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/apply-wasm-lagacy-code-in-the-browser/">第 6 章：应用 WebAssembly—— 在浏览器中运行遗留代码</a></li>




  <li class="child level active"><a href="/wasm-definitive-guide/wasm-tables/">第 7 章：WebAssembly 表</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/wasm-in-the-server/">第 8 章：在服务器中运行 WebAssembly</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/applied-wasm-tensorflow-js/">第 9 章：应用 WebAssembly——TensorFlow.js</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/rust/">第 10 章：Rust</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/wasi/">第 11 章：WASI（WebAssembly 系统接口）</a></li>




  <li class="child level "><a href="/wasm-definitive-guide/appendix/">附录</a></li>

      
    

    
      </ul>
    

  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      
     
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">目录</a></li>
      </ul>
     

      <nav id="TableOfContents">
  <ul>
    <li><a href="#静态链接与动态链接">静态链接与动态链接</a></li>
    <li><a href="#在模块中创建表">在模块中创建表</a></li>
    <li><a href="#webassembly-中的动态链接">WebAssembly 中的动态链接</a></li>
    <li><a href="#注释">注释</a></li>
  </ul>
</nav>

      
<div class="subscribe-module col-12 mt-1">
    <img src="/img/wechat.webp" alt="image" title="Jimmy Song的微信公众号"/>
    <p class="text-center pt-1">关注「几米宋」微信公众号，获取本站更新</p>
    
    
     <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4029167986768912"
     crossorigin="anonymous"></script>
     <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-4029167986768912"
       data-ad-slot="6856371908"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
    <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    
    
</div>



    </div>
    

    <main class="py-md-3 pl-md-3 docs-content col-xl-8" role="main">

      <article class="article">

          

          <h1>WebAssembly 表</h1>

          <div class="article-style">
            <blockquote>
<p>餐桌（Table）是教导和练习的中心，不仅是餐桌礼仪，而且是谈话、体贴、宽容、家庭感情，以及除了小步舞曲之外的所有其他礼貌社会的配套。</p>
<p>——Judith Martin</p>
</blockquote>
<p>餐桌是分享想法和故事的一个很好的隐喻。与他人一起吃饭总是比自己一个人吃饭更有趣。如果你把一群来自各行各业的人聚集在一起，你可能有谈不完的话题。没有人拥有所有的故事。一些参与者可能分享相同故事的某些方面。其他人可能有他们自己的版本。然而，为了发挥作用，确实必须有一定的礼仪、克制，并愿意接受其他参与者提供的东西。那些行为不端、喋喋不休或相互踩线的客人会毁了大家的晚餐。</p>
<p>表是 WebAssembly 的另一个特点，使得它成为一个现代软件系统，其功能依赖将由额外的模块来满足。与静态链接库相比，它提供了相当于动态共享库的能力。不是每个模块都需要提供它所需要的一切来完成其工作。这将使效率低的可怕。相反，它是根据一些其他模块在运行时满足需求的承诺来编写的。这在 C 和 C++ 世界中被称为动态链接。很明显，我的餐桌论只是对表（Table）这个词的玩味，但就像在吃饭时需要有一些协调来分享想法一样，我们需要在库之间分享行为。让我们更仔细地探讨这个想法，然后看看 WebAssembly 如何支持它。</p>
<h2 id="静态链接与动态链接">静态链接与动态链接</h2>
<p>任何在 Twitter 上关注我的人都知道我妻子是一个多么了不起的厨师。她来自一个伟大的厨师家庭，并有机会向大量慷慨的导师学习。人们经常看到我发布的关于她制作的烹饪艺术的帖子，并向我索取食谱。这通常不像发送一个链接那么容易，因为她经常把来自多个来源的想法结合起来，然后把她自己的想法放在上面。</p>
<p>在我们家，她可以依靠她所积累的食谱库。她可以说，&ldquo;用那本书里的酱汁做这个。用另一本书中描述的技术准备牛肉。在牛肉达到你想要的熟度后，加入这些我认为会让它变得更好的额外成分&rdquo;。</p>
<p>在我们家，她可以参考已知来源的步骤和配料表，并以她的额外步骤修正过程。但是当她想把菜谱交给别人时，她不能依靠他们有这些书。在这种情况下，她将不得不把她的来源中的食谱复制到一个自成一体的新食谱文件中。这时，所有的步骤和成分都会被定义在一个地方，菜谱就可以发给别人了。</p>
<p>这基本上就是静态链接和动态链接的区别。一个典型的程序需要读写文件的内容，打开窗口，收集用户的输入，或在网络上发送消息。这些都是很常见的任务，它们通常可以作为操作系统提供的库中的功能。当你希望使用其中的一个函数时，你会告诉链接器允许运行时链接。否则，它将抱怨缺少符号参考。</p>
<p>在运行时，操作系统将搜索其配置路径，告诉它在哪里可以找到这些共享库。在启动程序之前，它将把库中的功能映射到一个可以动态链接到其余代码的内存位置。
这种做法有很多原因。首先是效率问题。比方说，你有一个名为 <code>a ()</code> 的函数被十几个其他程序引用。通过静态链接，每个可执行程序都有自己的副本。程序占用了更多的磁盘空间。它们在运行时的内存足迹也会变大。这不是对空间的有效利用。
如果动态库被加载到一个共享的内存空间，那么我们大概只需要磁盘上一个版本的文件副本。根据你的操作系统的复杂性，你可能也只需要内存中的一个副本。</p>
<p>动态链接的库通常有自己的发布周期。如果你正在使用你一个可执行程序的系统库，你可能会更新你的操作系统并得到一个带有安全问题补丁的新版本的库。只要编号机制正常，并且是向后兼容的，假定你可以通过使用打了补丁的版本来加强你的应用程序的安全性，而不需要做任何其他事情。</p>
<p>请看例 7-1，这是一个独立的函数，没有 <code>main ()</code> 函数。它的目的是作为一个库来使用。我们可以把它编译成一个静态库，但现在我们只需创建目标代码，并将我们的 <code>main ()</code> 程序与之链接。注意， 这个函数也依赖于 <code>printf ()</code>，所以它必须导入 <code>stdio.h</code> 头。</p>
<p>例 7-1. 一个有函数调用的库</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sayHello</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span><span class="n">printf</span> <span class="p">(</span><span class="s">&#34;% s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在例 7-2 中，你会看到<code>main ()</code>函数首先调用<code>printf ()</code>，然后再调用我们的函数，该函数也调用<code>printf ()</code>。</p>
<p>例 7-2. 一个调用我们的库函数的 <code>main ()</code> 方法示例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">extern</span> <span class="kt">void</span> <span class="nf">sayHello</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span><span class="n">printf</span> <span class="p">(</span><span class="s">&#34;Hello, world.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="n">sayHello</span> <span class="p">(</span><span class="s">&#34;How are you?&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认情况下，如果你用 clang 编译这两个文件，它将生成一个输出文件。我让它使用默认的名字。当我们运行它时，我们会看到我们所期望的行为。默认情况下，编译器将对系统库使用动态链接，以满足我已经列出的所有需求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; clang main.c library.c brian@tweezer ~/g/w/s/ch07&gt; ls
</span></span><span class="line"><span class="cl">a.out* library.c main.c
</span></span><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; ./a.out
</span></span><span class="line"><span class="cl">Hello, world.
</span></span><span class="line"><span class="cl">How are you?
</span></span></code></pre></div><p>你可以用 nm 命令验证我们在这里使用了动态链接。首先，我们看到我们的二进制文件提供了<code>main ()</code>和<code>sayHello ()</code>的定义，但没有<code>printf ()</code>。这是从标准库中重复使用的函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; nm a.out 
</span></span><span class="line"><span class="cl"><span class="m">0000000100008008</span> d __dyld_private 
</span></span><span class="line"><span class="cl"><span class="m">0000000100000000</span> T __mh_execute_header
</span></span><span class="line"><span class="cl">0000000100003f10 T _main
</span></span><span class="line"><span class="cl">                 U _printf
</span></span><span class="line"><span class="cl">0000000100003f50 T _sayHello
</span></span><span class="line"><span class="cl">                 U dyld_stub_binder
</span></span></code></pre></div><p>在 Linux 上，你可以看到同样的构建步骤产生了一个带有额外功能的二进制文件。这很自然，因为它是一个不同的操作系统，有不同的运行时和不同的二进制格式。突出的一点是，我们的方法是在二进制文件中提供的，但<code>printf ()</code>却没有。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@bbfcfm:~/src/hello$ nm a.out
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> B __bss_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> b completed.8060
</span></span><span class="line"><span class="cl"><span class="m">0000000000404020</span> D __data_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000404020</span> W data_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000401080</span> t deregister_tm_clones
</span></span><span class="line"><span class="cl"><span class="m">0000000000401070</span> T _dl_relocate_static_pie
</span></span><span class="line"><span class="cl">00000000004010f0 t __do_global_dtors_aux
</span></span><span class="line"><span class="cl">0000000000403e08 d __do_global_dtors_aux_fini_array_entry <span class="m">0000000000404028</span> D __dso_handle
</span></span><span class="line"><span class="cl">0000000000403e10 d _DYNAMIC
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> D _edata
</span></span><span class="line"><span class="cl"><span class="m">0000000000404038</span> B _end
</span></span><span class="line"><span class="cl"><span class="m">0000000000401218</span> T _fini
</span></span><span class="line"><span class="cl"><span class="m">0000000000401120</span> t frame_dummy
</span></span><span class="line"><span class="cl">0000000000403e00 d __frame_dummy_init_array_entry
</span></span><span class="line"><span class="cl">000000000040216c r __FRAME_END__
</span></span><span class="line"><span class="cl"><span class="m">0000000000404000</span> d _GLOBAL_OFFSET_TABLE_
</span></span><span class="line"><span class="cl">                 w __gmon_start__
</span></span><span class="line"><span class="cl"><span class="m">0000000000402024</span> r __GNU_EH_FRAME_HDR
</span></span><span class="line"><span class="cl"><span class="m">0000000000401000</span> T _init
</span></span><span class="line"><span class="cl">0000000000403e08 d __init_array_end
</span></span><span class="line"><span class="cl">0000000000403e00 d __init_array_start
</span></span><span class="line"><span class="cl"><span class="m">0000000000402000</span> R _IO_stdin_used
</span></span><span class="line"><span class="cl"><span class="m">0000000000401210</span> T __libc_csu_fini
</span></span><span class="line"><span class="cl">00000000004011a0 T __libc_csu_init
</span></span><span class="line"><span class="cl">                 U __libc_start_main@@GLIBC_2.2.5
</span></span><span class="line"><span class="cl"><span class="m">0000000000401130</span> T main
</span></span><span class="line"><span class="cl">                 U printf@@GLIBC_2.2.5
</span></span><span class="line"><span class="cl">00000000004010b0 t register_tm_clones
</span></span><span class="line"><span class="cl"><span class="m">0000000000401170</span> T sayHello
</span></span><span class="line"><span class="cl"><span class="m">0000000000401040</span> T _start
</span></span><span class="line"><span class="cl"><span class="m">0000000000404030</span> D __TMC_END__
</span></span></code></pre></div><p>otool 命令是另一个可以在 macOS 上使用的命令，它可以显示哪些动态库是成功执行你的二进制文件所需要的。显示的是系统库的 macOS 版本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; otool -L a.out 
</span></span><span class="line"><span class="cl">a.out:
</span></span><span class="line"><span class="cl">   /usr/lib/libSystem.B.dylib <span class="o">(</span>compatibility vers 1.0.0, current vers 1292.60.1<span class="o">)</span>
</span></span></code></pre></div><p>otool 在 Linux 上并不存在，但我们可以通过使用 objdump 看到类似的结果。为了节省空间，我把部分输出删除了，但相关部分显示在下面的片段中。正如你所看到的，我们需要<code>libc.so.6</code>来满足我们二进制文件的需要。在 Windows 上也会有类似的工具来检查你的 DLL 依赖性。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@bbfcfm:~/src/hello$ objdump -x a.out
</span></span><span class="line"><span class="cl">    a.out:     file format elf64-x86-64
</span></span><span class="line"><span class="cl">    a.out
</span></span><span class="line"><span class="cl">    architecture: i386:x86-64, flags 0x00000112:
</span></span><span class="line"><span class="cl">    EXEC_P, HAS_SYMS, D_PAGED
</span></span><span class="line"><span class="cl">    start address 0x0000000000401040
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Dynamic Section:
</span></span><span class="line"><span class="cl">  NEEDED        	libc.so.6
</span></span><span class="line"><span class="cl">  INIT          	0x0000000000401000
</span></span><span class="line"><span class="cl">  FINI	          0x0000000000401218
</span></span><span class="line"><span class="cl">  INIT_ARRAY	    0x0000000000403e00
</span></span><span class="line"><span class="cl">  INIT_ARRAYSZ  	0x0000000000000008
</span></span><span class="line"><span class="cl">  FINI_ARRAY	    0x0000000000403e08
</span></span><span class="line"><span class="cl">  FINI_ARRAYSZ  	0x0000000000000008
</span></span><span class="line"><span class="cl">  HASH	          0x00000000004002e8
</span></span><span class="line"><span class="cl">  GNU_HASH      	0x0000000000400310
</span></span><span class="line"><span class="cl">  STRTAB	        0x0000000000400390
</span></span><span class="line"><span class="cl">  SYMTAB	        0x0000000000400330
</span></span><span class="line"><span class="cl">  STRSZ         	0x000000000000003f
</span></span><span class="line"><span class="cl">  SYMENT	        0x0000000000000018
</span></span><span class="line"><span class="cl">  DEBUG	          0x0000000000000000
</span></span><span class="line"><span class="cl">  PLTGOT	        0x0000000000404000
</span></span><span class="line"><span class="cl">  PLTRELSZ	      0x0000000000000018
</span></span><span class="line"><span class="cl">  PLTREL	        0x0000000000000007
</span></span><span class="line"><span class="cl">  JMPREL	        0x0000000000400428
</span></span><span class="line"><span class="cl">  RELA	          0x00000000004003f8
</span></span><span class="line"><span class="cl">  RELASZ	        0x0000000000000030
</span></span><span class="line"><span class="cl">  RELAENT	        0x0000000000000018
</span></span><span class="line"><span class="cl">  VERNEED	        0x00000000004003d8
</span></span><span class="line"><span class="cl">  VERNEEDNUM    	0x0000000000000001
</span></span><span class="line"><span class="cl">  VERSYM        	0x00000000004003d0
</span></span><span class="line"><span class="cl">Version References:
</span></span><span class="line"><span class="cl">  required from libc.so.6:
</span></span><span class="line"><span class="cl">    0x09691a75 0x00 <span class="m">02</span> GLIBC_2.2.5
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>WebAssembly 与操作系统显然不是一回事，但它得益于类似的概念。我们的选择是一样的：把所有的函数定义放到一个模块里，这样它就可以独立存在，或者从另一个模块调用行为，以满足我们的需要。考虑到我们要经常通过网络下载 WebAssembly 模块，让它们偏小是可取的。这也会影响到磁盘存储、模块验证、在内存中加载实例等。为此，我们有 Table 实例。</p>
<h2 id="在模块中创建表">在模块中创建表</h2>
<p>表实例有一些类似于我们在 <a href="../wasm-memeory/">第 4 章</a> 中介绍的 Memory 实例的特征。目前每个模块只能有一个，但它可以在模块中定义，也可以通过导入的对象传入。每个模块只有一个实例的限制在未来可能会被取消，但目前我们必须 遵守这一规定。</p>
<p>我们在 WebAssembly 中采用这种结构，而不是仅仅使用 Memory 实例，部分原因是后者可以被模块操纵。如果我们试图进行一次适当的晚餐谈话，我们不希望任何个人参与者改写礼貌的规则。在共享模块上也是如此。如果我们已经加载并验证了一个通过表实例导出函数的模块，我们不希望另一个模块给其他人带来麻烦。因此，你所能做的就是对存储在表中的函数引用进行间接函数调用。目前，函数引用是唯一可以存储在表实例中的东西，但这也有望在未来改变。</p>
<p>在这一点上，我不想把事情搞得太复杂，而是要回到 Wat 中的简单函数定义，以演示创建表实例和导出它们的方法。</p>
<p>在例 7-3 中，我创建了两个函数。<code>$add</code> 函数接收两个参数，将它们相加，然后返回结果。<code>$sub</code> 函数接收两个参数，用第一个参数减去第二个参数，然后返回结果。到目前为止，正如他们所说，那又怎样呢？这不过是前几章的复习内容。这里的区别在于接下来会发生什么。</p>
<p>例 7-3. 一个导出其表实例的模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>module
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$add</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.add<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>func <span class="nv">$sub</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.sub<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>table <span class="o">(</span><span class="nb">export</span> <span class="s2">&#34;tbl&#34;</span><span class="o">)</span> anyfunc <span class="o">(</span>elem <span class="nv">$add</span> <span class="nv">$sub</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></div><p>我们引入了一个新的 Wat 关键字 ——table。这定义了一个函数引用的集合。注意内联导出命令。我们将允许我们的主机环境通过<code>$add</code>和<code>$sub</code>函数调用方法，但不能通过它们的名字。宿主只能通过表的实例来调用行为。Anyfunc 类型目前是这个结构唯一允许的类型，正如我们之前指出的那样。根据 elem 引用中的排序，<code>$add</code>将在第 0 个位置，<code>$sub</code> 将在第 1 个位置 <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>。</p>
<p>正如你现在所知道的，我们可以把我们的 Wat 文件变成一个 Wasm 模块，并检查其内容，如下所示。注意表部分、类型部分和导出部分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; wat2wasm math.wat 
</span></span><span class="line"><span class="cl">brian@tweezer ~/g/w/s/ch07&gt; wasm-objdump -x math.wasm
</span></span><span class="line"><span class="cl">    math.wasm:      file format wasm 0x1
</span></span><span class="line"><span class="cl">    Section Details:
</span></span><span class="line"><span class="cl">    Type <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - <span class="nb">type</span> <span class="o">[</span>0<span class="o">]</span> <span class="o">(</span>i32, i32<span class="o">)</span> -&gt; i32
</span></span><span class="line"><span class="cl">    Function <span class="o">[</span>2<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>0<span class="o">]</span> <span class="nv">sig</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>1<span class="o">]</span> <span class="nv">sig</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">    Table <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - table <span class="o">[</span>0<span class="o">]</span> <span class="nv">type</span><span class="o">=</span>funcref <span class="nv">initial</span><span class="o">=</span><span class="m">2</span> <span class="nv">max</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">    Export <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - table <span class="o">[</span>0<span class="o">]</span> -&gt; <span class="s2">&#34;tbl&#34;</span>
</span></span><span class="line"><span class="cl">    Elem <span class="o">[</span>1<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - segment <span class="o">[</span>0<span class="o">]</span> <span class="nv">flags</span><span class="o">=</span><span class="m">0</span> <span class="nv">table</span><span class="o">=</span><span class="m">0</span> <span class="nv">count</span><span class="o">=</span><span class="m">2</span> - init <span class="nv">i32</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">      - elem <span class="o">[</span>0<span class="o">]</span> <span class="o">=</span> func <span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl">      - elem <span class="o">[</span>1<span class="o">]</span> <span class="o">=</span> func <span class="o">[</span>1<span class="o">]</span>
</span></span><span class="line"><span class="cl">    Code <span class="o">[</span>2<span class="o">]</span>:
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>0<span class="o">]</span> <span class="nv">size</span><span class="o">=</span><span class="m">7</span>
</span></span><span class="line"><span class="cl">     - func <span class="o">[</span>1<span class="o">]</span> <span class="nv">size</span><span class="o">=</span><span class="m">7</span>
</span></span></code></pre></div><p>例 7-4 中的 JavaScript 实例化了我们的模块，就像我们在之前章节中做的那样。从那里，它从模块的导出部分提取 Table 实例。</p>
<p>例 7-4. 使用一个从 JavaScript 导出的表实例</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!doctype html&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>WASM Table test<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;utils.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;data:;base64,=&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">fetchAndInstantiate</span> <span class="p">(</span><span class="s1">&#39;math.wasm&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="kd">var</span> <span class="nx">tbl</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">tbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">t</span> <span class="o">=</span> <span class="nx">tbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span><span class="s2">&#34;3 + 1 =&#34;</span> <span class="o">+</span> <span class="nx">tbl</span><span class="p">.</span><span class="nx">get</span> <span class="p">(</span><span class="mi">0</span><span class="p">)(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span><span class="s2">&#34;3 - 1 =&#34;</span> <span class="o">+</span> <span class="nx">tbl</span><span class="p">.</span><span class="nx">get</span> <span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>在我们获取引用后，我们可以检索到与第 0 个位置相关的函数并调用它。请记住，从<code>get ()</code> 调用回来的是一个函数的引用。为了调用它，我们提交第二组括号中的参数，然后将结果打印到控制台。然后我们对第 1 个位置上的函数也这样做。</p>
<p>通过 HTTP 发送 HTML，并打开 JavaScript 控制台。当你的浏览器执行该代码时，它应该如图 7-1 所示。</p>
<p>















<figure  id="figure-图-7-1-通过表实例调用方法的输出结果">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="../images/f7-1.png" alt="图 7-1. 通过表实例调用方法的输出结果" loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图 7-1. 通过表实例调用方法的输出结果
    </figcaption></figure>
</p>
<p>表的实例只被定义为有两个引用。如果你试图访问一个超过 <code>tbl.length</code> 的位置，就会引起一个异常。</p>
<h2 id="webassembly-中的动态链接">WebAssembly 中的动态链接</h2>
<p>我们的最后一个例子是在 WebAssembly 中使用动态链接。我们将定义两个模块。一个将包含我们预先定义的 <code>$add</code> 和 <code>$sub</code> 方法。第一个模块在例 7-5 中。与我们之前看到的主要区别是，这个模块从主机中导入了一个表。我们用 elem 指令将算术函数放入这个表中。加法函数被存放在 0 号位置，减法函数被存放在 1 号位置。</p>
<p>例 7-5. 一个动态链接的模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>module
</span></span><span class="line"><span class="cl">  <span class="o">(</span>import <span class="s2">&#34;js&#34;</span> <span class="s2">&#34;table&#34;</span> <span class="o">(</span>table <span class="m">2</span> anyfunc<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$add</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.add<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="nv">$sub</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$a</span>
</span></span><span class="line"><span class="cl">      get_local <span class="nv">$b</span>
</span></span><span class="line"><span class="cl">      i32.sub<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>elem <span class="o">(</span>i32.const 0<span class="o">)</span> <span class="nv">$add</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>elem <span class="o">(</span>i32.const 1<span class="o">)</span> <span class="nv">$sub</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></div><p>我们的第二个模块将输出两个函数，myadd 和 mysub。它向其客户宣传加减两个数字的能力。在内部，它将调用导入表实例中的函数引用，我们也从主机的 JavaScript 环境中导入。</p>
<p>我们所宣传的功能的实现见于例 7-6。两个函数都调用了 call_indirect 指令。在前面的章节中，我们看到使用调用指令来调用当前模块中定义的函数。call_indirect 指令通过确定你想调用的表的哪个元素来调用一个函数。</p>
<p>例 7-6. 依赖于动态链接模块的一个模块</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>module
</span></span><span class="line"><span class="cl">  <span class="o">(</span>import <span class="s2">&#34;js&#34;</span> <span class="s2">&#34;table&#34;</span> <span class="o">(</span>table <span class="m">2</span> anyfunc<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span><span class="nb">type</span> <span class="nv">$sig</span> <span class="o">(</span>func <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="o">(</span><span class="nb">export</span> <span class="s2">&#34;myadd&#34;</span><span class="o">)</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span> <span class="o">(</span>call_indirect <span class="o">(</span><span class="nb">type</span> <span class="nv">$sig</span><span class="o">)</span> <span class="o">(</span>get_local <span class="nv">$a</span><span class="o">)</span> <span class="o">(</span>get_local <span class="nv">$b</span><span class="o">)</span> <span class="o">(</span>i32.const 0<span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>func <span class="o">(</span><span class="nb">export</span> <span class="s2">&#34;mysub&#34;</span><span class="o">)</span> <span class="o">(</span>param <span class="nv">$a</span> i32<span class="o">)</span> <span class="o">(</span>param <span class="nv">$b</span> i32<span class="o">)</span> <span class="o">(</span>result i32<span class="o">)</span> <span class="o">(</span>call_indirect <span class="o">(</span><span class="nb">type</span> <span class="nv">$sig</span><span class="o">)</span> <span class="o">(</span>get_local <span class="nv">$a</span><span class="o">)</span> <span class="o">(</span>get_local <span class="nv">$b</span><span class="o">)</span> <span class="o">(</span>i32.const 1<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span></code></pre></div><p>其中一个会让你眼前一亮的东西是类型指令的使用。这将定义一个函数的签名，以便在 WebAssembly 中提供一定程度的类型安全。我们的想法是，一个导入的表函数应该有你想要调用的签名。</p>
<p>在这种情况下，我们定义了一个函数签名，它接收两个 i32 并返回一个 i32。当我们通过表调用这些方法时，我们表明这是我们所期望的类型。在签名之后，我们将函数的参数推到堆栈中，最后推到表的位置号。对于加法，它的常量值是 0，代表表的第一个位置。对于减法，它将是第二个位置。</p>
<p>我们在例 7-7 中把这一切放在一起。我们做的第一件事是创建一个共享的表实例。这将通过 importObject 传递给两个模块。不同的是，math2.wat 模块将其函数 <code>$add</code> 和 <code>$sub</code> 分别写在 0 和 1 的位置。mymath.wat 模块在从主机 JavaScript 环境中调用 myadd 和 mysub 时间接地调用了这些位置。作为调用的一部分，它们也将把它们被赋予的参数传递给动态链接的函数。</p>
<p>因为我们处理的是两个模块，所以我们的实例化机制略有不同。我们调用 <code>Promise.all ()</code> 方法，而不是等待一个单一的 Promise，该方法会阻止所有的从属 Promise 得到满足。在这种情况下，这意味着两个模块都已加载并准备就绪。</p>
<p>例 7-7. 实例化两个模块并在它们之间建立动态链接</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>WASM Dynamic Linking test<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span> <span class="p">/&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;utils.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;data:;base64,=&#34;</span> <span class="p">/&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl"> <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">importObject</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">js</span><span class="o">:</span> <span class="p">{</span><span class="nx">memory</span><span class="o">:</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span> <span class="p">({</span> <span class="nx">initial</span><span class="o">:</span> <span class="mi">1</span><span class="p">}),</span>
</span></span><span class="line"><span class="cl">	      <span class="nx">table</span><span class="o">:</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Table</span> <span class="p">({</span><span class="nx">initial</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">element</span><span class="o">:</span><span class="s2">&#34;anyfunc&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span> <span class="p">([</span><span class="nx">fetchAndInstantiate</span> <span class="p">(</span><span class="s1">&#39;math2.wasm&#39;</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	        <span class="nx">fetchAndInstantiate</span> <span class="p">(</span><span class="s1">&#39;mymath.wasm&#39;</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">]).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">instances</span><span class="p">)</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span><span class="s2">&#34;4 + 3 =&#34;</span> <span class="o">+</span> <span class="nx">instances</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">exports</span><span class="p">.</span><span class="nx">myadd</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span><span class="s2">&#34;4 - 3 =&#34;</span> <span class="o">+</span> <span class="nx">instances</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">exports</span><span class="p">.</span><span class="nx">mysub</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>  
</span></span><span class="line"><span class="cl"> <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>一旦模块都可用，这段代码就用一些参数调用 myadd 和 mysub 方法。注意我们正在选择第二个模块实例，代表我们的行为版本。这是一个数组的实例，而不是一个单一的实例。</p>
<p>在通过 HTTP 提供服务后，浏览器中的结果如图 7-2 所示。一个模块通过共享的 Table 实例间接调用在另一个模块中实现的行为。</p>
<p>















<figure  id="figure-图-7-2-调用我们的动态链接函数的输出结果">
  <div class="d-flex justify-content-center">
    <div class="w-100" ><img src="../images/f7-2.png" alt="图 7-2. 调用我们的动态链接函数的输出结果" loading="lazy" data-zoomable /></div>
  </div><figcaption>
      图 7-2. 调用我们的动态链接函数的输出结果
    </figcaption></figure>
</p>
<p>至此，我们对 WebAssembly 作为一个平台的主要功能元素的介绍结束了。本书的其余部分将以这些基础知识为基础，向你展示几个例子，说明 WebAssembly 现在是如何被使用的，以及它在未来将如何被使用。这包括一些我们尚未涉及的更高级的功能。</p>
<h2 id="注释">注释</h2>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>基于 0 的集合中的第二个位置。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

          </div>

          

<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/webassembly/">WebAssembly</a>
  
</div>



          
          
          <div class="article-widget">
            
<div class="container-xl row post-nav">
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1" href="/wasm-definitive-guide/apply-wasm-lagacy-code-in-the-browser/" rel="next">
    <div class="meta-nav">上一页</div>
    <p>应用 WebAssembly：在浏览器中运行遗留代码</p></a>
  
  
  
  <a class="col-6 post-nav-item btn btn-lg mb-md-1"  href="/wasm-definitive-guide/wasm-in-the-server/" rel="prev">
    <div class="meta-nav">下一页</div>
    <p>在服务器中运行 WebAssembly</p></a>
  
</div>

          </div>
          

        <div class="body-footer">
          <p>最近更新于 2023-02-01</p>

          



          


  
  
  

  

  
  <section id="comments" class="mb-3 pt-0">
    <script>
  let themeNumber = localStorage.getItem('wcTheme');
  var giscusTheme = "light";
  if (themeNumber == 1){
    giscusTheme = "dark";
  }
  console.log(giscusTheme)
  let giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-theme": giscusTheme,
    "data-repo":"rootsongjc/cloud-native-library",
    "data-repo-id":"MDEwOlJlcG9zaXRvcnkyMTQ2MjY2NDg=",
    "data-category":"Announcements",
    "data-category-id":"DIC_kwDODMrxWM4CPL7J",
    "data-mapping":"pathname",
    "data-reactions-enabled":"1",
    "data-emit-metadata":"0",
    "data-input-position":"top",
    "data-theme":giscusTheme,
    "data-lang":"zh-CN",
    "data-loading":"lazy",
    "crossorigin":"anonymous",
    "origins":"https://jimmysong.io",
    "originsRegex":"http://localhost:[0-9]+",
    "async": "",
  };

  let giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.querySelector('#comments').appendChild(giscusScript);
</script>

  </section>
  



          


        </div>

      </article>

      <footer class="site-footer">

  



  

  
  <div class="copyright py-4 bg-footer">
      <div class="row justify-content-center">
        <div class="text-center footer-color">
          <p class="mb-0">© 2017-2023 jimmysong.io all rights reserved</p>
        </div>
    </div>
  </div>

</footer>


    </main>
  </div>
</div>

  </div>

  <div class="page-footer">
    
    
  </div>

  


<script src="/js/vendor-bundle.min.46271ef31da3f018e9cd1b59300aa265.js"></script>




  

  
  

  

  
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/highlight.min.js" integrity="sha512-Ypjm0o7jOxAd4hpdoppSEN0TQOC19UtPAqD+4s5AlXmUvbmmS/YMxYqAqarQYyxTnB6/rqip9qcxlNB/3U9Wdg==" crossorigin="anonymous"></script>
    
    
  










  
  <script id="search-hit-fuse-template" type="text/x-template">
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <div class="article-metadata search-hit-type">{{relpermalink}}</div>
          <a href="{{relpermalink}}">{{title}}</a>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin="anonymous"></script>
  












  
  
  
  
  
  
  







<script id="page-data" type="application/json">{"use_headroom":false}</script>










  
  


<script src="/zh/js/wowchemy.min.24983018b0e5661cd5fe1822254286ea.js"></script>







  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">引用</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> 复制
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> 下载
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

  <script src="/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js" type="module"></script>
<script>

var mybutton = document.getElementById("backTopBtn");


window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    mybutton.style.display = "block";
  } else {
    mybutton.style.display = "none";
  }
}


function topFunction() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}
</script>






<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
<script>
  anchors.add();
</script>



<script>



(function() {
  'use strict';

  if(!document.queryCommandSupported('copy')) {
    return;
  }

  function flashCopyMessage(el, msg) {
    el.className = "highlight-copy-btn";
    el.textContent = msg;
    setTimeout(function() {
      el.textContent = "";
      el.className = "highlight-copy-btn fa fa-copy";
    }, 1000);
  }

  function selectText(node) {
    var selection = window.getSelection();
    var range = document.createRange();
    range.selectNodeContents(node);
    selection.removeAllRanges();
    selection.addRange(range);
    return selection;
  }

  function addCopyButton(containerEl) {
    var copyBtn = document.createElement("button");
    copyBtn.className = "highlight-copy-btn fa fa-copy";
    copyBtn.textContent = "";

    var codeEl = containerEl.firstElementChild;
    copyBtn.addEventListener('click', function() {
      try {
        var selection = selectText(codeEl);
        document.execCommand('copy');
        selection.removeAllRanges();
        
        flashCopyMessage(copyBtn, '已复制')
        
      } catch(e) {
        console && console.log(e);
        flashCopyMessage(copyBtn, 'Failed :\'(')
      }
    });

    containerEl.appendChild(copyBtn);
  }

  
  var highlightBlocks = document.getElementsByClassName('highlight');
  Array.prototype.forEach.call(highlightBlocks, addCopyButton);
})();
</script>



<script>

function Collapse(e){
  var node = document.getElementById(e);
  if (node.className.indexOf('fa-angle-down') > -1){
    node.setAttribute("class", "fa-solid fa-angle-right");
    }else{
    node.setAttribute("class", "fa-solid fa-angle-down");
    }
}
</script>


</body>
</html>
