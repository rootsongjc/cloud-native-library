<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>使用 tctl 安装 | 云原生资料库</title>
    <link>https://lib.jimmysong.io/tsb/setup/self-managed/</link>
      <atom:link href="https://lib.jimmysong.io/tsb/setup/self-managed/index.xml" rel="self" type="application/rss+xml" />
    <description>使用 tctl 安装</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>zh</language><lastBuildDate>Wed, 09 Aug 2023 12:00:00 +0800</lastBuildDate>
    <image>
      <url>https://lib.jimmysong.io/media/sharing.png</url>
      <title>使用 tctl 安装</title>
      <link>https://lib.jimmysong.io/tsb/setup/self-managed/</link>
    </image>
    
    <item>
      <title>演示安装</title>
      <link>https://lib.jimmysong.io/tsb/setup/self-managed/demo-installation/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/setup/self-managed/demo-installation/</guid>
      <description>&lt;p&gt;本指南将引导你完成 TSB 演示配置文件的安装，该配置文件旨在快速概述 TSB 的功能。演示配置文件包括 PostgreSQL、Elasticsearch 和 LDAP，所有这些都在 Kubernetes 集群上进行编排。为了确保无缝体验，你的集群应包含 3-6 个节点，每个节点至少配备 4 个 vCPU 和 16 GB 内存。集群还必须建立默认存储类，并能够为 Elasticsearch 和 PostgreSQL 创建最小容量为 100 GB 的持久卷声明。&lt;/p&gt;
&lt;p&gt;在继续之前，请参阅 &lt;a href=&#34;../../../release-notes-announcements/support-policy#kubernetes-versions&#34;&gt;TSB 支持政策&lt;/a&gt;来验证与你的 Kubernetes 版本的兼容性。&lt;/p&gt;
&lt;h2 id=&#34;先决条件&#34;&gt;先决条件&lt;/h2&gt;
&lt;p&gt;要安装演示配置文件，请确保你已完成以下步骤：&lt;/p&gt;
&lt;h3 id=&#34;1-获取-tctl-并同步镜像&#34;&gt;1. 获取 &lt;code&gt;tctl&lt;/code&gt; 并同步镜像&lt;/h3&gt;
&lt;p&gt;首先按照&lt;a href=&#34;../../requirements-and-download#download&#34;&gt;下载部分&lt;/a&gt;中概述的步骤下载 &lt;code&gt;tctl&lt;/code&gt; 。此外，按照同步容器镜像中所述&lt;a href=&#34;../../requirements-and-download#sync-tetrate-service-bridge-images&#34;&gt;同步所需的容器镜像&lt;/a&gt;。&lt;/p&gt;
&lt;h3 id=&#34;2-设置-kubernetes-集群&#34;&gt;2. 设置 Kubernetes 集群&lt;/h3&gt;
&lt;p&gt;准备一个要安装演示配置文件的 Kubernetes 集群。创建集群的具体步骤取决于你的环境。有关创建 Kubernetes 集群的具体说明，请参阅你的环境手册。&lt;/p&gt;
&lt;h4 id=&#34;使用-kind&#34;&gt;使用 kind&lt;/h4&gt;
&lt;p&gt;如果你使用 &lt;a href=&#34;https://kind.sigs.k8s.io/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;kind&lt;/a&gt; 集群进行安装，请按照以下步骤操作：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;创建类型集群后，安装 &lt;a href=&#34;https://metallb.universe.tf/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;MetalLB&lt;/a&gt; 以使 TSB 能够使用 &lt;code&gt;LoadBalancer&lt;/code&gt; 类型的服务。&lt;/li&gt;
&lt;li&gt;配置&lt;a href=&#34;https://metallb.universe.tf/configuration/#layer-2-configuration&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;第 2 层配置&lt;/a&gt;，指定 &lt;code&gt;kind&lt;/code&gt; Docker 网络 IP 范围内的 IP 地址范围。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;安装&#34;&gt;安装&lt;/h2&gt;
&lt;p&gt;请按照以下步骤安装演示配置文件：&lt;/p&gt;
&lt;h3 id=&#34;1执行-tctl-install-demo&#34;&gt;1.执行 &lt;code&gt;tctl install demo&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;确保你的 Kubernetes 上下文设置为目标集群。使用 &lt;code&gt;tctl install demo&lt;/code&gt; 命令，该命令利用 &lt;code&gt;kubectl&lt;/code&gt; 配置中的 &lt;code&gt;current-context&lt;/code&gt; 。在继续之前，请确认引用了正确的 Kubernetes 集群。&lt;/p&gt;
&lt;p&gt;运行安装命令，如下所示。你可以使用 &lt;code&gt;--admin-password&lt;/code&gt; 选项（自版本 1.4.0 起可用）提供管理员密码。或者，将为你生成一个密码。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install demo &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --registry &amp;lt;registry-location&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --admin-password &amp;lt;password&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;安装注意事项&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    在某些资源受限或负载较重的环境中，安装时间可能比预期长，并且 &lt;code&gt;tctl&lt;/code&gt; 工具可能会退出。 &lt;code&gt;tctl install demo&lt;/code&gt; 命令是幂等的，允许你重新运行它，直到安装完成。
&lt;/div&gt;

&lt;p&gt;成功安装后，你的 Kubernetes 集群将托管管理和控制平面，并将创建一个名为 &lt;code&gt;tetrate&lt;/code&gt; 的组织。&lt;/p&gt;
&lt;h2 id=&#34;访问网络用户界面&#34;&gt;访问网络用户界面&lt;/h2&gt;
&lt;p&gt;要访问 TSB Web UI，请执行以下步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;从演示安装命令的输出中获取 URL 和凭据。查找类似于以下内容的输出：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Controlplane installed successfully!
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Management Plane UI accessible at: https://31.224.214.68:8443
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;Admin credentials: username: admin, password: yGWx1s!Y@&lt;span class=&#34;p&#34;&gt;&amp;amp;&lt;/span&gt;-KBe0V
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;使用提供的 URL 和管理凭据登录 Web UI。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;提示&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    即使你跳过快速入门，也请考虑&lt;a href=&#34;../../../quickstart/tenant/&#34;&gt;创建租户&lt;/a&gt;，因为遵循本网站上的示例可能需要它。
&lt;/div&gt;

&lt;h2 id=&#34;进一步配置&#34;&gt;进一步配置&lt;/h2&gt;
&lt;p&gt;有关演示安装的其他自定义（例如载入集群），请参阅&lt;a href=&#34;../onboarding-clusters/&#34;&gt;载入集群指南&lt;/a&gt;。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>管理平面安装</title>
      <link>https://lib.jimmysong.io/tsb/setup/self-managed/management-plane-installation/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/setup/self-managed/management-plane-installation/</guid>
      <description>&lt;p&gt;本页面将向你展示如何在生产环境中安装Tetrate Service Bridge管理平面。&lt;/p&gt;
&lt;p&gt;在开始之前，请确保你已经：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;检查了&lt;a href=&#34;../../requirements-and-download&#34;&gt;要求&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;检查了&lt;a href=&#34;../../components#management-plane&#34;&gt;TSB管理平面组件&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;检查了&lt;a href=&#34;../../certificate/certificate-setup&#34;&gt;证书类型&lt;/a&gt;和&lt;a href=&#34;../../certificate/certificate-requirements&#34;&gt;内部证书要求&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;检查了&lt;a href=&#34;../../firewall_information&#34;&gt;防火墙信息&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果你正在升级以前的版本，请还要检查&lt;a href=&#34;../../../operations/postgresql&#34;&gt;PostgreSQL备份和还原&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;../../requirements-and-download#download&#34;&gt;下载&lt;/a&gt;了Tetrate Service Bridge CLI（&lt;code&gt;tctl&lt;/code&gt;）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;../../requirements-and-download#sync-tetrate-service-bridge-images&#34;&gt;同步&lt;/a&gt;了Tetrate Service Bridge镜像&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;管理平面operator&#34;&gt;管理平面Operator&lt;/h2&gt;
&lt;p&gt;为了保持安装简单，但仍允许许多自定义配置选项，我们创建了一个管理平面Operator。该Operator将在集群中运行，并根据ManagementPlane自定义资源中描述的内容引导管理平面的启动。它会监视更改并执行它们。为了帮助创建正确的自定义资源文档（CRD），我们已经添加了能力到我们的&lt;code&gt;tctl&lt;/code&gt;客户端，用于创建基本清单，然后你可以根据你的要求进行修改。之后，你可以将清单直接应用于适当的集群，或在你的源控制操作的集群中使用。&lt;/p&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;关于 Operator&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    如果你想了解有关Operator的内部工作原理以及Operator模式的更多信息，请查看&lt;a href=&#34;https://kubernetes.io/docs/concepts/extend-kubernetes/operator/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Kubernetes文档&lt;/a&gt;。
&lt;/div&gt;

&lt;p&gt;创建清单，以允许你从私有Docker注册表安装管理平面Operator：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest management-plane-operator &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --registry &amp;lt;registry-location&amp;gt; &amp;gt; managementplaneoperator.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;OpenShift&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;使用安装清单命令创建的&lt;code&gt;managementplaneoperator.yaml&lt;/code&gt;文件可以通过使用kubectl客户端直接应用于适当的集群：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f managementplaneoperator.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;应用清单后，你将在&lt;code&gt;tsb&lt;/code&gt;命名空间中看到Operator正在运行：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get pod -n tsb
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;RedHat 生态系统目录&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    }
TSB已在RedHat生态系统目录上获得了认证并列出。可以按照以下说明或通过&lt;a href=&#34;https://catalog.redhat.com/software/container-stacks/detail/63224dc0bc45b8cf6605f7e8&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;此处&lt;/a&gt;在OpenShift平台上安装TSB。
&lt;/div&gt;

&lt;p&gt;使用安装清单命令创建的&lt;code&gt;managementplaneoperator.yaml&lt;/code&gt;文件可以通过使用&lt;code&gt;oc&lt;/code&gt;客户端直接应用于适当的集群：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc apply -f managementplaneoperator.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;应用清单后，你将在&lt;code&gt;tsb&lt;/code&gt;命名空间中看到Operator正在运行：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc get pod -n tsb
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例输出：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-text&#34; data-lang=&#34;text&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;NAME                                            READY   STATUS    RESTARTS   AGE
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tsb-operator-management-plane-d4c86f5c8-b2zb5   1/1     Running   0          8s
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;配置机密&#34;&gt;配置机密&lt;/h2&gt;
&lt;p&gt;管理平面组件需要一些机密，用于内部和外部通信目的。以下是你需要创建的机密列表。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;机密名称&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;admin-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;TSB将创建一个默认的管理员用户，用户名为：admin，这是该特殊帐户的密码的单向哈希。这些凭据保存在你的IdP（身份提供者）之外，而其他任何凭据必须存储在你的IdP中。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;tsb-certs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;TLS证书，类型为&lt;code&gt;kubernetes.io/tls&lt;/code&gt;。必须具有&lt;code&gt;tls.key&lt;/code&gt;和&lt;code&gt;tls.cert&lt;/code&gt;值。TLS证书可以是自签名的，也可以由公共CA颁发。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;postgres-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;包含：&lt;br /&gt; 1. PostgreSQL用户名和密码。&lt;br /&gt; 2. 用于在PostgreSQL配置为呈现自签名证书时验证PostgreSQL连接的CA证书。仅当在Postgres设置中将&lt;code&gt;sslMode&lt;/code&gt;设置为&lt;code&gt;verify-ca&lt;/code&gt;或&lt;code&gt;verify-full&lt;/code&gt;时，才会进行TLS验证。有关详细信息，请参见&lt;a href=&#34;../../../refs/install/managementplane/v1alpha1/spec#postgressettings&#34;&gt;PostgresSettings&lt;/a&gt;。 &lt;br /&gt; 3. 如果Postgres配置了互通TLS，则包含客户端证书和私钥。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;elastic-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Elasticsearch用户名和密码。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;es-certs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Elasticsearch配置为呈现自签名证书时，用于验证Elasticsearch连接的CA证书。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;ldap-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;仅在使用LDAP作为身份提供者（IdP）时设置。包含LDAP &lt;code&gt;binddn&lt;/code&gt;和&lt;code&gt;bindpassword&lt;/code&gt;。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;custom-host-ca&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;仅在使用LDAP作为IdP时设置。用于验证LDAP连接的CA证书，当LDAP配置为呈现自签名证书时。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;iam-oidc-client-secret&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;仅在使用OIDC与任何IdP时设置。包含OIDC客户端密钥和设备客户端密钥。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;azure-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;仅在使用Azure AD作为IdP时设置。用于连接到Azure AD进行团队和用户同步的客户端密钥。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;xcp-central-cert&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;XCP中央TLS证书。请转到&lt;a href=&#34;../../certificate/certificate-requirements&#34;&gt;内部证书要求&lt;/a&gt;以获取更多详细信息。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;使用tctl生成机密&#34;&gt;使用tctl生成机密&lt;/h3&gt;
&lt;div class=&#34;alert-warning-title&#34;&gt;
    &lt;p&gt;注意&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-warning&#34;&gt;
    自1.7以来，TSB支持自动管理TSB管理平面TLS证书、内部证书和中间Istio CA证书。有关详细信息，请转到&lt;a href=&#34;../../certificate/automated-certificate-management&#34;&gt;自动证书管理&lt;/a&gt;。这意味着你不再需要创建&lt;code&gt;tsb-certs&lt;/code&gt;和&lt;code&gt;xcp-central-cert&lt;/code&gt;机密。以下示例将假定你正在使用自动证书管理。
&lt;/div&gt;

&lt;p&gt;可以通过将它们作为命令行标志传递给&lt;code&gt;tctl&lt;/code&gt;管理平面机密命令，以正确的格式生成这些机密。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;OIDC作为IdP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;以下命令将生成包含Elasticsearch、Postgres、OIDC和管理员凭据以及TSB TLS证书的&lt;code&gt;managementplane-secrets.yaml&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest management-plane-secrets &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --elastic-password &amp;lt;elastic-password&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --elastic-username &amp;lt;elastic-username&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --oidc-client-secret &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;lt;oidc-client-secret&amp;gt;&amp;#34;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --postgres-password &amp;lt;postgres-password&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --postgres-username &amp;lt;postgres-username&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --tsb-admin-password &amp;lt;tsb-admin-password&amp;gt; &amp;gt; managementplane-secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;LDAP 作为 IdP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;以下命令将生成包含Elasticsearch、Postgres、LDAP和管理员凭据以及TSB TLS证书的&lt;code&gt;managementplane-secrets.yaml&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest management-plane-secrets &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --elastic-password &amp;lt;elastic-password&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --elastic-username &amp;lt;elastic-username&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --ldap-bind-dn &amp;lt;ldap-bind-dn&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --ldap-bind-password &amp;lt;ldap-bind-password&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --postgres-password &amp;lt;postgres-password&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --postgres-username &amp;lt;postgres-username&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --tsb-admin-password &amp;lt;tsb-admin-password&amp;gt; &amp;gt; managementplane-secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看&lt;a href=&#34;../../../reference/cli/reference/install#tctl-install-manifest-management-plane-secrets&#34;&gt;CLI参考&lt;/a&gt;文档以获取所有可用选项，例如为&lt;code&gt;Elasticsearch&lt;/code&gt;、&lt;code&gt;PostgreSQL&lt;/code&gt;和&lt;code&gt;LDAP&lt;/code&gt;提供CA证书。你还可以通过运行以下帮助命令，从&lt;code&gt;tctl&lt;/code&gt;中检查绑定的解释：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest management-plane-secrets --help
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;应用机密&#34;&gt;应用机密&lt;/h3&gt;
&lt;p&gt;一旦你创建了机密清单，就可以将其添加到源代码控制或应用于你的集群。&lt;/p&gt;
&lt;div class=&#34;alert-warning-title&#34;&gt;
    &lt;p&gt;Vault 注入&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-warning&#34;&gt;
    如果你正在为某些组件使用&lt;code&gt;Vault&lt;/code&gt;注入，请在将其应用到集群之前，从你创建的清单中删除适用的机密。
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;OpenShift&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f managementplane-secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在应用它之前，请记住，你必须允许不同管理平面组件的服务帐户访问你的OpenShift授权策略。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc adm policy add-scc-to-user anyuid -n tsb -z tsb-iam
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc adm policy add-scc-to-user anyuid -n tsb -z tsb-oap
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;现在可以应用它：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc apply -f managementplane-secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;注意：TSB将每小时自动执行此操作，因此此命令只需在初始安装后运行一次。&lt;/p&gt;
&lt;h3 id=&#34;验证安装&#34;&gt;验证安装&lt;/h3&gt;
&lt;p&gt;为验证你的安装成功，请使用管理员用户登录。尝试连接到TSB UI或使用&lt;code&gt;tctl&lt;/code&gt; CLI工具登录。&lt;/p&gt;
&lt;p&gt;TSB UI可通过以下命令返回的外部IP的端口8443访问：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;标准&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get svc -n tsb envoy
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;OpenShift&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc get svc -n tsb envoy
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;要将&lt;code&gt;tctl&lt;/code&gt;的默认配置文件设置为指向你的新TSB集群，请执行以下操作：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;标准&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl config clusters &lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt; default --bridge-address &lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;kubectl get svc -n tsb envoy --output &lt;span class=&#34;nv&#34;&gt;jsonpath&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{.status.loadBalancer.ingress[0].ip}&amp;#39;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt;:8443
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;AWS&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl config clusters &lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt; default --bridge-address &lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;kubectl get svc -n tsb envoy --output &lt;span class=&#34;nv&#34;&gt;jsonpath&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{.status.loadBalancer.ingress[0].hostname}&amp;#39;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt;:8443
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;现在，你可以使用&lt;code&gt;tctl&lt;/code&gt;登录，并提供组织名称和管理员帐户凭据。租户字段是可选的，可以在稍后配置，当添加租户到平台时。&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-bash{outputLines:&#34; data-lang=&#34;bash{outputLines:&#34;&gt;tctl login
Organization: tetrate
Tenant:
Username: admin
Password: *****
Login Successful!
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;查看&lt;a href=&#34;../../tctl_connect&#34;&gt;使用tctl连接到TSB&lt;/a&gt;以获取有关如何配置tctl的更多详细信息。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>加入集群</title>
      <link>https://lib.jimmysong.io/tsb/setup/self-managed/onboarding-clusters/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/setup/self-managed/onboarding-clusters/</guid>
      <description>&lt;p&gt;本页介绍如何将 Kubernetes 集群加入现有的 Tetrate Service Bridge（TSB）管理平面。&lt;/p&gt;
&lt;p&gt;在开始之前，请确保你已经完成以下操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;检查 &lt;a href=&#34;../../requirements-and-download&#34;&gt;要求&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;../management-plane-installation&#34;&gt;安装 TSB 管理平面&lt;/a&gt; 或 &lt;a href=&#34;../demo-installation&#34;&gt;演示安装&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;使用 tctl 登录管理平面（&lt;a href=&#34;../../tctl-connect&#34;&gt;tctl 连接&lt;/a&gt;）&lt;/li&gt;
&lt;li&gt;检查 &lt;a href=&#34;../../components#control-plane&#34;&gt;TSB 控制平面组件&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;隔离边界&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    &lt;p&gt;TSB 1.6 引入了隔离边界，允许你在 Kubernetes 集群内或跨多个集群中拥有多个 TSB 管理的 Istio 环境。隔离边界的一个好处是你可以执行控制平面的金丝雀升级。&lt;/p&gt;
&lt;p&gt;要启用隔离边界，你必须使用环境变量 &lt;code&gt;ISTIO_ISOLATION_BOUNDARIES=true&lt;/code&gt; 更新操作员部署，并在控制平面 CR 中包含 &lt;code&gt;isolationBoundaries&lt;/code&gt; 字段。
有关更多信息，请参阅 &lt;a href=&#34;../../isolation-boundaries&#34;&gt;隔离边界&lt;/a&gt;。&lt;/p&gt;

&lt;/div&gt;

&lt;h2 id=&#34;创建集群对象&#34;&gt;创建集群对象&lt;/h2&gt;
&lt;p&gt;要为集群创建正确的凭据，以便与管理平面通信，你需要使用管理平面 API 创建一个集群对象。&lt;/p&gt;
&lt;p&gt;根据你的需求调整以下 &lt;code&gt;yaml&lt;/code&gt; 对象，并保存到名为 &lt;code&gt;new-cluster.yaml&lt;/code&gt; 的文件中。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;api.tsb.tetrate.io/v2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;Cluster&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;cluster-name-in-tsb&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;organization&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;organization-name&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;{}&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;TSB 中的集群名称&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    &amp;lt;cluster-name-in-tsb&amp;gt; 是 TSB 中你集群的指定名称。你将在 TSB API 中使用此名称，例如在工作区和配置组中的命名空间选择器以及创建以下的 &lt;code&gt;ControlPlane&lt;/code&gt; CR 时使用。此名称必须唯一。
&lt;/div&gt;

&lt;p&gt;有关可配置字段的详细信息，请参阅 &lt;a href=&#34;../../../refs/tsb/v2/cluster&#34;&gt;Cluster&lt;/a&gt; 对象的参考文档。&lt;/p&gt;
&lt;p&gt;要在管理平面上创建集群对象，请使用 &lt;code&gt;tctl&lt;/code&gt; 来应用包含集群详细信息的 &lt;code&gt;yaml&lt;/code&gt; 文件。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl apply -f new-cluster.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;部署operator&#34;&gt;部署Operator&lt;/h2&gt;
&lt;p&gt;接下来，你需要在集群中安装必要的组件，以加入集群并将其连接到管理平面。&lt;/p&gt;
&lt;p&gt;你必须部署两个运营商。首先是控制平面运营商，负责管理 Istio、SkyWalking 和其他各种组件。其次是数据平面运营商，负责管理网关。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest cluster-operators &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --registry &amp;lt;registry-location&amp;gt; &amp;gt; clusteroperators.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;标准&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;install manifest cluster-operators&lt;/code&gt; 命令将输出所需运营商的 Kubernetes 清单。然后，我们可以将其添加到源代码控制或应用到集群中：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f clusteroperators.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;OpenShift&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;install manifest cluster-operators&lt;/code&gt; 命令将输出所需运营商的 Kubernetes 清单。然后，我们可以将其添加到源代码控制或应用到集群中：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;oc apply -f clusteroperators.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;注意&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    对于下面的 &lt;a href=&#34;#configuring-secrets&#34;&gt;配置密钥&lt;/a&gt; 和 &lt;a href=&#34;#control-plane-installation&#34;&gt;控制平面安装&lt;/a&gt; 步骤，你必须为每个集群单独创建密钥和自定义资源的 YAML 文件。
换句话说，对每个集群重复这些步骤，并确保传递上面设置的 &lt;code&gt;&amp;lt;cluster-name-in-tsb&amp;gt;&lt;/code&gt; 值，然后将两个 YAML 文件应用到正确的集群。
&lt;/div&gt;

&lt;h2 id=&#34;配置密钥&#34;&gt;配置密钥&lt;/h2&gt;
&lt;p&gt;控制平面需要密钥以便与管理平面进行身份验证。这些包括服务帐户密钥、Elasticsearch 凭据，以及如果使用自签名证书进行管理平面、XCP 或 Elasticsearch 的 CA 捆绑包。以下是你需要创建的一些密钥的列表。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;密钥名称&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;elastic-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Elasticsearch 用户名和密码。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;es-certs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;当 Elasticsearch 配置为呈现自签名证书时，用于验证 Elasticsearch 连接的 CA 证书。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;redis-credentials&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;包含：&lt;br /&gt; 1. Redis 密码。&lt;br /&gt; 2. 使用 TLS 的标志。&lt;br /&gt; 3. 当 Postgres 配置为呈现自签名证书时，用于验证 Redis 连接的 CA 证书。&lt;br /&gt; 4. 如果 Redis 配置了互联 TLS，则包含客户端证书和私钥。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;xcp-central-ca-bundle&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;用于验证由 XCP Central 呈现的证书的 CA 捆绑包。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;mp-certs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;用于验证管理平面 API 的 TSB 管理平面证书，如果管理平面配置为呈现自签名证书，则为 CA 证书。这是用于签署前端 envoy TLS 证书的 CA。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;cluster-service-account&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;用于集群到控制平面之间的身份验证的服务帐户密钥。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;central-cert&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;用于签署前端 envoy TLS 证书的 CA 证书。&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;edgectl-cluster&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;包含：&lt;br /&gt; 1. 前端 envoy 的 TLS 证书和密钥。&lt;br /&gt; 2. 用于验证和管理各种组件连接的 CA 证书。&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;请按照以下步骤为集群创建密钥：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用以下命令创建密钥文件，如 &lt;code&gt;cluster-secrets.yaml&lt;/code&gt;：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install secrets cluster-secrets &amp;gt; cluster-secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;使用文本编辑器打开 &lt;code&gt;cluster-secrets.yaml&lt;/code&gt; 文件，将以下字段替换为集群的实际值：&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cluster_name&lt;/code&gt;: 替换为集群名称。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;tsb_operator_namespace&lt;/code&gt;: 替换为 Istio 运营商的命名空间。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;tsb_control_plane_namespace&lt;/code&gt;: 替换为 TSB 控制平面的命名空间。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;elastic_username&lt;/code&gt; 和 &lt;code&gt;elastic_password&lt;/code&gt;: 替换为 Elasticsearch 的用户名和密码。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;redis_password&lt;/code&gt;: 替换为 Redis 的密码。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;xcp_central_ca_bundle&lt;/code&gt;: 如果使用自签名证书，将其替换为 XCP Central 的 CA 捆绑包。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mp_certs_ca_bundle&lt;/code&gt;: 如果管理平面使用自签名证书，将其替换为管理平面的 CA 捆绑包。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以下是示例 &lt;code&gt;cluster-secrets.yaml&lt;/code&gt; 文件的一部分，其中包含需要替换的字段示例：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nt&#34;&gt;apiVersion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;api.tsb.tetrate.io/v2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;kind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;TSB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;metadata&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;cluster-secrets&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;organization&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;organization-name&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;spec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;cluster_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;cluster-name-in-tsb&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;tsb_operator_namespace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;tsb-operator&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;tsb_control_plane_namespace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;tetrate-system&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;secrets&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;elastic_username&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;elasticsearch-username&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;elastic_password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;elasticsearch-password&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;redis_password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;redis-password&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;xcp_central_ca_bundle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;xcp-central-ca-bundle&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;mp_certs_ca_bundle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;&amp;lt;mp-certs-ca-bundle&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;使用以下命令应用密钥文件：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f cluster-secrets.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;在完成上述步骤后，集群应配置好密钥并准备好连接到管理平面。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;安装控制平面&#34;&gt;安装控制平面&lt;/h2&gt;
&lt;p&gt;现在，你可以使用 tctl 来安装控制平面。请将以下命令中的 &lt;code&gt;&amp;lt;cluster-name-in-tsb&amp;gt;&lt;/code&gt; 替换为集群的实际名称：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install control-plane &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --cluster-name &amp;lt;cluster-name-in-tsb&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --registry &amp;lt;registry-location&amp;gt; &amp;gt; controlplane.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;接下来，使用以下命令将控制平面清单应用到集群中：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f controlplane.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这将在集群中安装 Istio 和相关组件，并将其连接到管理平面。完成后，你的 Kubernetes 集群将成功加入 Tetrate Service Bridge 环境。&lt;/p&gt;
&lt;h2 id=&#34;后续步骤&#34;&gt;后续步骤&lt;/h2&gt;
&lt;p&gt;一旦集群成功加入 TSB，你可以继续执行其他操作，例如：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;../../gateway-configuration&#34;&gt;为应用程序配置网关&lt;/a&gt;。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;../../traffic-management&#34;&gt;为应用程序添加流量管理规则&lt;/a&gt;。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;../../observability&#34;&gt;监视和跟踪应用程序&lt;/a&gt;。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;../../multicluster&#34;&gt;在多个集群之间配置服务网格&lt;/a&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些操作将帮助你在 Tetrate Service Bridge 中有效地管理和操作微服务应用程序。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>TSB 卸载</title>
      <link>https://lib.jimmysong.io/tsb/setup/self-managed/uninstallation/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/setup/self-managed/uninstallation/</guid>
      <description>&lt;p&gt;本页描述了从集群中卸载 TSB 的步骤。&lt;/p&gt;
&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;注意&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    此过程对于所有平面（管理、控制和数据平面）都是相似的，因为你需要删除平面的任何自定义资源，然后删除Operator本身。
&lt;/div&gt;

&lt;h2 id=&#34;数据平面&#34;&gt;数据平面&lt;/h2&gt;
&lt;p&gt;由于数据平面负责在你的集群中部署入口网关，因此第一步是从你的集群中删除所有 &lt;code&gt;IngressGateway&lt;/code&gt; 自定义资源。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete ingressgateways.install.tetrate.io --all --all-namespaces
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这将删除集群中每个命名空间中部署的所有 &lt;code&gt;IngressGateway&lt;/code&gt;。运行此命令后，数据平面Operator将删除每个网关的部署和相关资源。这可能需要一些时间来确保它们都成功删除。&lt;/p&gt;
&lt;p&gt;为确保你正常删除 &lt;code&gt;istio-operator&lt;/code&gt; 部署，你必须按以下顺序缩放并删除数据平面Operator命名空间中的剩余对象：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n istio-gateway scale deployment tsb-operator-data-plane --replicas&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n istio-gateway delete istiooperators.install.istio.io --all
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n istio-gateway delete deployment --all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这将删除存储在数据平面Operator命名空间中的 TSB 和 Istio Operator部署。现在你可以清理验证和变异 Web 钩子。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tsb-operator-data-plane-egress &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tsb-operator-data-plane-ingress &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tsb-operator-data-plane-tier1
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete mutatingwebhookconfigurations.admissionregistration.k8s.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tsb-operator-data-plane-egress &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tsb-operator-data-plane-ingress &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tsb-operator-data-plane-tier1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;删除控制平面将删除所有 TSB 组件以及 TSB 使用的 Istio 控制平面，并使集群中的任何 Sidecar 失去功能。&lt;/p&gt;
&lt;h2 id=&#34;控制平面&#34;&gt;控制平面&lt;/h2&gt;
&lt;p&gt;要删除 TSB 控制平面，首先删除与其关联的 IstioOperator。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete controlplanes.install.tetrate.io --all --all-namespaces
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;TSB Operator在 istio-system 命名空间中清理 Istio 组件可能需要一些时间，但一旦完成，删除验证和变异 Web 钩子。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io tsb-operator-control-plane
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete mutatingwebhookconfigurations.admissionregistration.k8s.io tsb-operator-control-plane
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io xcp-edge-istio-system
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;然后删除 &lt;code&gt;istio-system&lt;/code&gt; 和 &lt;code&gt;xcp-multicluster&lt;/code&gt; 命名空间。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete namespace istio-system xcp-multicluster
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;为了清理集群范围的资源，请使用 &lt;code&gt;tctl install manifest&lt;/code&gt; 命令来呈现 &lt;code&gt;cluster-operators&lt;/code&gt; 清单并删除生成的清单。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest cluster-operators --registry&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;dummy &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    kubectl delete -f - --ignore-not-found
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete clusterrole xcp-operator-edge
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete clusterrolebinding xcp-operator-edge
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;现在清理集群中与控制平面相关的自定义资源定义。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete crd &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    clusters.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    controlplanes.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    edgexcps.install.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    egressgateways.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    egressgateways.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    gatewaygroups.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    globalsettings.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    ingressgateways.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    ingressgateways.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    securitygroups.security.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    securitysettings.security.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    servicedefinitions.registry.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    serviceroutes.traffic.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tier1gateways.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tier1gateways.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    trafficgroups.traffic.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    trafficsettings.traffic.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    workspaces.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    workspacesettings.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --ignore-not-found
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;此时，Kubernetes 集群中的所有 TSB 资源都已删除，但为了从 TSB 配置中删除此集群，你必须运行以下命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl delete cluster &amp;lt;cluster&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;管理平面&#34;&gt;管理平面&lt;/h2&gt;
&lt;p&gt;要卸载管理平面，你需要删除描述管理平面配置的 &lt;code&gt;ManagementPlane&lt;/code&gt; CR，这将强制管理平面Operator删除与之相关的任何组件。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n tsb delete managementplanes.install.tetrate.io --all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;然后，删除管理平面Operator。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl -n tsb delete deployment tsb-operator-management-plane
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;最后，删除验证和变异 Web 钩子。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io tsb-operator-management-plane
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete  mutatingwebhookconfigurations.admissionregistration.k8s.io tsb-operator-management-plane
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io xcp-central-tsb
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete mutatingwebhookconfigurations.admissionregistration.k8s.io xcp-central-tsb
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;为了清理集群范围的资源，请使用 &lt;code&gt;tctl install manifest&lt;/code&gt; 命令来呈现 &lt;code&gt;management-plane-operator&lt;/code&gt; 清单并删除它。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest management-plane-operator --registry&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;dummy &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; kubectl delete -f - --ignore-not-found
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete clusterrole xcp-operator-central
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete clusterrolebinding xcp-operator-central
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;现在清理集群中与管理平面相关的自定义资源定义。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete crd &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    centralxcps.install.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    clusters.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    egressgateways.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    egressgateways.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    gatewaygroups.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    globalsettings.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    ingressgateways.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    ingressgateways.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    managementplanes.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    securitygroups.security.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    securitysettings.security.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    servicedefinitions.registry.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    serviceroutes.traffic.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tier1gateways.gateway.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    tier1gateways.install.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    trafficgroups.traffic.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    trafficsettings.traffic.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    workspaces.xcp.tetrate.io &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    workspacesettings.xcp.tetrate.io
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>TSB 升级</title>
      <link>https://lib.jimmysong.io/tsb/setup/self-managed/upgrade/</link>
      <pubDate>Wed, 09 Aug 2023 12:00:00 +0800</pubDate>
      <guid>https://lib.jimmysong.io/tsb/setup/self-managed/upgrade/</guid>
      <description>&lt;p&gt;本页将指导你如何使用 &lt;code&gt;tctl&lt;/code&gt; CLI 升级 TSB，呈现不同Operator的 Kubernetes 清单，并使用 &lt;code&gt;kubectl&lt;/code&gt; 将它们应用到集群中以进行升级。&lt;/p&gt;
&lt;p&gt;在开始之前，请确保你已完成以下操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;检查新版本的 &lt;a href=&#34;../../requirements-and-download#requirements&#34;&gt;要求&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基于Operator的版本之间的升级过程相对简单。一旦Operator的 Pod 使用新的发布映像进行了更新，新生成的Operator Pod 将升级所有必要的组件以适应新版本。&lt;/p&gt;
&lt;h2 id=&#34;创建备份&#34;&gt;创建备份&lt;/h2&gt;
&lt;p&gt;为了确保在出现问题时可以恢复一切，请为管理平面和每个集群的本地控制平面创建备份。&lt;/p&gt;
&lt;h3 id=&#34;备份管理平面&#34;&gt;备份管理平面&lt;/h3&gt;
&lt;h4 id=&#34;备份-tctl-二进制文件&#34;&gt;备份 &lt;code&gt;tctl&lt;/code&gt; 二进制文件&lt;/h4&gt;
&lt;p&gt;由于每个新的 &lt;code&gt;tctl&lt;/code&gt; 二进制文件可能都附带了新的Operator和配置来部署和配置 TSB，因此你应该备份当前正在使用的 &lt;code&gt;tctl&lt;/code&gt; 二进制文件。请在同步新映像之前执行此操作。&lt;/p&gt;
&lt;p&gt;将带有版本后缀的 &lt;code&gt;tctl&lt;/code&gt; 二进制文件（例如 &lt;code&gt;-1.3.0&lt;/code&gt;）复制到一个位置，以便在需要时快速还原旧版本。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cp ~/.tctl/bin/tctl ~/.tctl/bin/tctl-&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;version&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果你不小心丢失了二进制文件，你可以从 &lt;a href=&#34;https://binaries.dl.tetrate.io/public/raw/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;此网址&lt;/a&gt; 找到正确的版本。但强烈建议你备份当前的副本以确保安全。&lt;/p&gt;
&lt;h4 id=&#34;备份-managementplane-cr&#34;&gt;备份 ManagementPlane CR&lt;/h4&gt;
&lt;p&gt;通过执行以下命令创建 &lt;code&gt;ManagementPlane&lt;/code&gt; CR 的备份：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get managementplane -n tsb -o yaml &amp;gt; mp-backup.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;备份-postgresql-数据库&#34;&gt;备份 PostgreSQL 数据库&lt;/h4&gt;
&lt;p&gt;&lt;a href=&#34;../../../operations/postgresql#create-a-backup-of-tsb-configuration&#34;&gt;创建 PostgreSQL 数据库的备份&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;连接到数据库的确切过程可能因你的环境而异，请参考你的环境的文档。&lt;/p&gt;
&lt;h3 id=&#34;备份控制平面自定义资源&#34;&gt;备份控制平面自定义资源&lt;/h3&gt;
&lt;p&gt;通过在每个已上线集群上执行以下命令，创建所有 &lt;code&gt;ControlPlane&lt;/code&gt; CR 的备份：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl get controlplane -n istio-system -o yaml &amp;gt; cp-backup.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;升级过程&#34;&gt;升级过程&lt;/h2&gt;
&lt;h3 id=&#34;下载-tctl-和同步映像&#34;&gt;下载 &lt;code&gt;tctl&lt;/code&gt; 和同步映像&lt;/h3&gt;
&lt;p&gt;现在你已经创建了备份，请 &lt;a href=&#34;../../requirements-and-download#download&#34;&gt;下载新版本的 &lt;code&gt;tctl&lt;/code&gt; 二进制文件&lt;/a&gt;，然后获取新的 TSB 容器映像。&lt;/p&gt;
&lt;p&gt;有关如何执行此操作的详细信息在 &lt;a href=&#34;../../requirements-and-download#sync-tetrate-service-bridge-images&#34;&gt;要求和下载页面&lt;/a&gt; 中有描述。&lt;/p&gt;
&lt;h3 id=&#34;创建管理平面operator&#34;&gt;创建管理平面Operator&lt;/h3&gt;
&lt;p&gt;创建基本清单，它将允许你从私有 Docker 注册表中更新管理平面Operator：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest management-plane-operator &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --registry &amp;lt;your-docker-registry&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    &amp;gt; managementplaneoperator.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;管理命名空间名称&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    从 TSB 0.9.0 开始，默认的管理平面命名空间名称是 &lt;code&gt;tsb&lt;/code&gt;，而不是较早版本中使用的 &lt;code&gt;tcc&lt;/code&gt;。如果你使用早于 0.9.0 的版本安装了 TSB，则你的管理平面可能位于 &lt;code&gt;tcc&lt;/code&gt; 命名空间中。你需要添加 &lt;code&gt;--management-namespace tcc&lt;/code&gt; 标志以反映这一点。
&lt;/div&gt;

&lt;div class=&#34;alert-note-title&#34;&gt;
    &lt;p&gt;自定义&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;alert alert-note&#34;&gt;
    由 install 命令创建的 managementplaneoperator.yaml 文件现在可以用作管理平面升级的基本模板。如果你的现有 TSB 配置包含在标准配置之上的特定调整，你应该将它们复制到新模板中。
&lt;/div&gt;

&lt;p&gt;现在，将清单添加到源代码控制或直接使用 kubectl 客户端将其应用到管理平面集群：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f managementplaneoperator.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;应用清单后，你将在 &lt;code&gt;tsb&lt;/code&gt; 命名空间中看到新的Operator运行：&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code class=&#34;language-bash{outputLines:2-3}&#34; data-lang=&#34;bash{outputLines:2-3}&#34;&gt;kubectl get pod -n tsb
名称                                            准备就绪   状态    重启   年龄
tsb-operator-management-plane-d4c86f5c8-b2zb5   1/1     运行中   0          8s
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;有关清单以及如何配置它的更多信息，请查看 &lt;a href=&#34;../../../refs/install/managementplane/v1alpha1/spec&#34;&gt;&lt;code&gt;ManagementPlane&lt;/code&gt; CR 参考&lt;/a&gt;。&lt;/p&gt;
&lt;h3 id=&#34;创建控制平面和数据平面operator&#34;&gt;创建控制平面和数据平面Operator&lt;/h3&gt;
&lt;p&gt;要在你的应用程序集群中部署新的控制平面和数据平面Operator，必须运行 &lt;a href=&#34;../../../../reference/cli/reference/install#tctl-install-manifest-cluster-operators&#34;&gt;&lt;code&gt;tctl install manifest cluster-operators&lt;/code&gt;&lt;/a&gt; 来检索新版本的控制平面和数据平面Operator清单。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;tctl install manifest cluster-operators &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    --registry &amp;lt;your-docker-registry&amp;gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;    &amp;gt; clusteroperators.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;:::note 自定义
clusteroperators.yaml 文件现在可用于你的集群升级。如果你的现有控制平面和数据平面具有标准配置之上的特定调整，你应该将它们复制到模板中。
:::&lt;/p&gt;
&lt;h3 id=&#34;查看-tier1gateways-和-ingressgateways&#34;&gt;查看 tier1gateways 和 ingressgateways&lt;/h3&gt;
&lt;p&gt;由于 &lt;a href=&#34;https://github.com/istio/istio/pull/36928&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Istio 1.14&lt;/a&gt; 中引入的修复，当同时设置 &lt;code&gt;replicaCount&lt;/code&gt; 和 &lt;code&gt;autoscaleEnaled&lt;/code&gt; 时，将会忽略 &lt;code&gt;replicaCount&lt;/code&gt;，只会应用自动缩放配置。这可能导致 &lt;code&gt;tier1gateways&lt;/code&gt; 和 &lt;code&gt;ingressgateways&lt;/code&gt; 在升级过程中暂时缩减到 1 个副本，直到应用自动缩放配置&lt;/p&gt;
&lt;p&gt;。为了避免此问题，你可以编辑 &lt;code&gt;tier1gateway&lt;/code&gt; 或 &lt;code&gt;ingressgateway&lt;/code&gt; 规范，删除 &lt;code&gt;replicas&lt;/code&gt; 字段，由于当前部署已由 HPA 控制器管理，因此这将允许你使用所需的配置升级 Pod。&lt;/p&gt;
&lt;p&gt;你可以通过运行以下命令获取所有 &lt;code&gt;tier1gateways&lt;/code&gt; 或 &lt;code&gt;ingressgateways&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get tier1gateway.install -A
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl get ingressgateway.install -A
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;应用清单&#34;&gt;应用清单&lt;/h3&gt;
&lt;p&gt;现在，将清单添加到源代码控制或直接使用 kubectl 客户端将其应用到适当的集群中：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f clusteroperators.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;有关每个清单以及如何配置它们的更多信息，请查看以下指南：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;../../../refs/install/controlplane/v1alpha1/spec&#34;&gt;ControlPlane 资源参考&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;../../../refs/install/dataplane/v1alpha1/spec&#34;&gt;Data Plane 资源参考&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;../../../refs/install/kubernetes/k8s&#34;&gt;Kubernetes 资源参考&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;回滚&#34;&gt;回滚&lt;/h2&gt;
&lt;p&gt;如果出现问题并且你想回滚 TSB 到之前的版本，你需要回滚管理平面和控制平面。&lt;/p&gt;
&lt;h3 id=&#34;回滚控制平面&#34;&gt;回滚控制平面&lt;/h3&gt;
&lt;h4 id=&#34;缩减-istio-operator-和-tsb-operator&#34;&gt;缩减 &lt;code&gt;istio-operator&lt;/code&gt; 和 &lt;code&gt;tsb-operator&lt;/code&gt;&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl scale deployment &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;   -l &lt;span class=&#34;s2&#34;&gt;&amp;#34;platform.tsb.tetrate.io/component in (tsb-operator,istio)&amp;#34;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;   -n istio-system &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;   --replicas&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;删除-istiooperator-资源&#34;&gt;删除 &lt;code&gt;IstioOperator&lt;/code&gt; 资源&lt;/h4&gt;
&lt;p&gt;删除Operator将需要删除保护 istio 对象的 finalizer，使用以下命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl patch iop tsb-istiocontrolplane -n istio-system --type&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;json&amp;#39;&lt;/span&gt; -p&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;[{&amp;#34;op&amp;#34;: &amp;#34;remove&amp;#34;, &amp;#34;path&amp;#34;: &amp;#34;/metadata/finalizers&amp;#34;, &amp;#34;value&amp;#34;:&amp;#34;&amp;#34;}]&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete istiooperator -n istio-system --all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;缩减-istio-operator-和-tsb-operator用于数据平面operator&#34;&gt;缩减 &lt;code&gt;istio-operator&lt;/code&gt; 和 &lt;code&gt;tsb-operator&lt;/code&gt;，用于数据平面Operator&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl scale deployment &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;   -l &lt;span class=&#34;s2&#34;&gt;&amp;#34;platform.tsb.tetrate.io/component in (tsb-operator,istio)&amp;#34;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;   -n istio-gateway &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;   --replicas&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;删除数据平面的-istiooperator-资源&#34;&gt;删除数据平面的 &lt;code&gt;IstioOperator&lt;/code&gt; 资源&lt;/h4&gt;
&lt;p&gt;从 1.5.11 开始，包含 ingressgateways 的 IOP 被拆分为每个 ingressgateway 都有一个 IOP。为了回滚到旧的 Istio 版本，我们需要删除保护 istio 对象的 finalizer，并使用以下命令删除所有Operator：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; iop in &lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;kubectl get iop -n istio-gateway --no-headers &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; grep -i &lt;span class=&#34;s2&#34;&gt;&amp;#34;tsb-ingress&amp;#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; awk &lt;span class=&#34;s1&#34;&gt;&amp;#39;{print $1}&amp;#39;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; kubectl patch iop &lt;span class=&#34;nv&#34;&gt;$iop&lt;/span&gt; -n istio-gateway --type&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;json&amp;#39;&lt;/span&gt; -p&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;[{&amp;#34;op&amp;#34;: &amp;#34;remove&amp;#34;, &amp;#34;path&amp;#34;: &amp;#34;/metadata/finalizers&amp;#34;, &amp;#34;value&amp;#34;:&amp;#34;&amp;#34;}]&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;done&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl delete istiooperator -n istio-gateway --all
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;创建集群operator回滚-controlplane-cr&#34;&gt;创建集群Operator，回滚 ControlPlane CR&lt;/h3&gt;
&lt;p&gt;使用之前版本的 &lt;code&gt;tctl&lt;/code&gt; 二进制文件，按照 &lt;a href=&#34;#create-the-control-and-data-planes&#34;&gt;创建集群Operator的说明&lt;/a&gt; 进行操作。&lt;/p&gt;
&lt;p&gt;然后应用 &lt;code&gt;ControlPlane&lt;/code&gt; CR 的备份：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f cp-backup.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;回滚管理平面&#34;&gt;回滚管理平面&lt;/h3&gt;
&lt;h4 id=&#34;缩减管理平面中的-pod&#34;&gt;缩减管理平面中的 Pod&lt;/h4&gt;
&lt;p&gt;缩减管理平面中的所有 Pod，使其处于非活动状态。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl scale deployment tsb iam -n tsb --replicas&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;恢复-postgresql&#34;&gt;恢复 PostgreSQL&lt;/h4&gt;
&lt;p&gt;从备份中 &lt;a href=&#34;../../../operations/postgresql#restore-a-backup&#34;&gt;恢复 PostgreSQL 数据库&lt;/a&gt;。连接到数据库的确切过程可能因你的环境而异，请参考你的环境的文档。&lt;/p&gt;
&lt;h4 id=&#34;恢复-tctl-并创建管理平面operator&#34;&gt;恢复 &lt;code&gt;tctl&lt;/code&gt; 并创建管理平面Operator&lt;/h4&gt;
&lt;p&gt;从你创建的备份副本中恢复 &lt;code&gt;tctl&lt;/code&gt;，或者 &lt;a href=&#34;https://binaries.dl.tetrate.io/public/raw/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;下载你想要使用的特定版本的二进制文件&lt;/a&gt;。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mv ~/.tctl/bin/tctl-&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;version&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt; ~/.tctl/bin/tctl
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;按照创建管理平面Operator的说明创建管理平面Operator。然后应用 &lt;code&gt;ManagementPlane&lt;/code&gt; CR 的备份：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl apply -f mp-backup.yaml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;恢复部署&#34;&gt;恢复部署&lt;/h4&gt;
&lt;p&gt;最后，恢复部署。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;kubectl scale deployment tsb iam -n tsb --replicas &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
  </channel>
</rss>
